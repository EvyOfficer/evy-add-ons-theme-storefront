<?php
/**
 * Plugin Name: Evy - Add-Ons Storefront
 * Plugin URI:  https://github.com/EvyOfficer
 * Description: Add-Ons for the Storefront theme, product visibility and related products.
 * Version:     1.0.0
 * Author:      EvyOfficer
 * Author URI:  https://github.com/EvyOfficer
 * License:     GPL-2.0+
 * License URI: http://www.gnu.org/licenses/gpl-2.0.txt
 * Text Domain: evy-add-ons-storefront
 * Domain Path: /languages
 */

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
defined('ABSPATH') || exit;

// ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà (Constants) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏•‡∏±‡πä‡∏Å‡∏≠‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
define( 'EVY_ADDONS_VERSION', '1.0.0' );
define( 'EVY_ADDONS_DIR', plugin_dir_path( __FILE__ ) );
define( 'EVY_ADDONS_URL', plugin_dir_url( __FILE__ ) );

// =================================================================================================
// üîß ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ User Roles ‡πÅ‡∏•‡∏∞ Product Categories (‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
// =================================================================================================

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Å Role ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (‡∏£‡∏ß‡∏° Short term accommodation)
 * ‡πÄ‡∏û‡∏¥‡πà‡∏° Role ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ Role ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÄ‡∏´‡πá‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î
 * ‡πÄ‡∏ä‡πà‡∏ô ['administrator', 'shop_manager']
 */
function evy_get_full_access_roles() {
    $roles = get_option('evy_full_access_roles', ['shop_manager']);
    if (!is_array($roles)) {
        $roles = array_filter(array_map('sanitize_key', explode(',', $roles)));
    }
    return $roles;
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á
 * ‡πÄ‡∏û‡∏¥‡πà‡∏° slug ‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
 * ‡πÄ‡∏ä‡πà‡∏ô ['short_term_accommodation', 'special_offers']
 */
function evy_get_restricted_categories_slugs() {
    $cats = get_option('evy_restricted_categories_slugs', ['short_term_accommodation']);
    if (!is_array($cats)) {
        $cats = array_filter(array_map('sanitize_title', explode(',', $cats)));
    }
    return $cats;
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Å Role ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏à‡∏≥‡∏Å‡∏±‡∏î (Restricted Category)
 * ‡πÄ‡∏û‡∏¥‡πà‡∏° Role ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ Role ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏à‡∏≥‡∏Å‡∏±‡∏î
 * ‡πÄ‡∏ä‡πà‡∏ô ['tenant', 'member']
 */
function evy_get_restricted_category_access_roles() {
    $roles = get_option('evy_restricted_category_access_roles', ['tenant']);
    if (!is_array($roles)) {
        $roles = array_filter(array_map('sanitize_key', explode(',', $roles)));
    }
    return $roles;
}

// =============================================================================
// ‚öôÔ∏è ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°: ‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°
// =============================================================================

add_action('admin_menu', 'evy_add_options_page');
function evy_add_options_page() {
    add_options_page(
        __('Evy Add-Ons Settings', 'evy-add-ons-storefront'),
        __('Evy Add-Ons', 'evy-add-ons-storefront'),
        'manage_options',
        'evy-addons-settings',
        'evy_render_settings_page'
    );
}

add_action('admin_init', 'evy_register_settings');
function evy_register_settings() {
    register_setting('evy_addons_settings', 'evy_full_access_roles', [
        'type' => 'array',
        'sanitize_callback' => 'evy_sanitize_csv',
        'default' => ['shop_manager'],
    ]);

    register_setting('evy_addons_settings', 'evy_restricted_categories_slugs', [
        'type' => 'array',
        'sanitize_callback' => 'evy_sanitize_csv',
        'default' => ['short_term_accommodation'],
    ]);

    register_setting('evy_addons_settings', 'evy_restricted_category_access_roles', [
        'type' => 'array',
        'sanitize_callback' => 'evy_sanitize_csv',
        'default' => ['tenant'],
    ]);

    add_settings_section(
        'evy_settings_section',
        __('User Roles & Categories', 'evy-add-ons-storefront'),
        '__return_false',
        'evy_addons_settings'
    );

    add_settings_field(
        'evy_full_access_roles',
        __('Full Access Roles', 'evy-add-ons-storefront'),
        'evy_field_full_access_roles',
        'evy_addons_settings',
        'evy_settings_section'
    );

    add_settings_field(
        'evy_restricted_categories_slugs',
        __('Restricted Category Slugs', 'evy-add-ons-storefront'),
        'evy_field_restricted_categories',
        'evy_addons_settings',
        'evy_settings_section'
    );

    add_settings_field(
        'evy_restricted_category_access_roles',
        __('Roles for Restricted Categories', 'evy-add-ons-storefront'),
        'evy_field_restricted_roles',
        'evy_addons_settings',
        'evy_settings_section'
    );
}

function evy_sanitize_csv($value) {
    if (!is_array($value)) {
        $value = explode(',', $value);
    }
    $value = array_filter(array_map('sanitize_key', array_map('trim', $value)));
    return $value;
}

function evy_field_full_access_roles() {
    $value = get_option('evy_full_access_roles', ['shop_manager']);
    if (is_array($value)) {
        $value = implode(',', $value);
    }
    echo '<input type="text" name="evy_full_access_roles" value="' . esc_attr($value) . '" class="regular-text" />';
    echo '<p class="description">' . esc_html__('Comma separated role slugs', 'evy-add-ons-storefront') . '</p>';
}

function evy_field_restricted_categories() {
    $value = get_option('evy_restricted_categories_slugs', ['short_term_accommodation']);
    if (is_array($value)) {
        $value = implode(',', $value);
    }
    echo '<input type="text" name="evy_restricted_categories_slugs" value="' . esc_attr($value) . '" class="regular-text" />';
    echo '<p class="description">' . esc_html__('Comma separated category slugs', 'evy-add-ons-storefront') . '</p>';
}

function evy_field_restricted_roles() {
    $value = get_option('evy_restricted_category_access_roles', ['tenant']);
    if (is_array($value)) {
        $value = implode(',', $value);
    }
    echo '<input type="text" name="evy_restricted_category_access_roles" value="' . esc_attr($value) . '" class="regular-text" />';
    echo '<p class="description">' . esc_html__('Comma separated role slugs', 'evy-add-ons-storefront') . '</p>';
}

function evy_render_settings_page() {
    echo '<div class="wrap">';
    echo '<h1>' . esc_html__('Evy Add-Ons Settings', 'evy-add-ons-storefront') . '</h1>';
    echo '<form method="post" action="options.php">';
    settings_fields('evy_addons_settings');
    do_settings_sections('evy_addons_settings');
    submit_button();
    echo '</form></div>';
}

// =================================================================================================
// üöÄ ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
// =================================================================================================

/**
 * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏°‡∏µ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
 */
function evy_user_has_full_access() {
    if (!is_user_logged_in()) return false;
    $user = wp_get_current_user();
    $roles = (array) $user->roles;
    return count(array_intersect($roles, evy_get_full_access_roles())) > 0;
}

/**
 * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏°‡∏µ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
 */
function evy_user_has_restricted_category_access() {
    if (!is_user_logged_in()) return false;
    $user = wp_get_current_user();
    return count(array_intersect($user->roles, evy_get_restricted_category_access_roles())) > 0;
}


// =================================================================================================
// ‚öôÔ∏è ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏õ‡∏•‡∏±‡πä‡∏Å‡∏≠‡∏¥‡∏ô (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
// =================================================================================================

// --- Start: Product Visibility Functions (‡∏à‡∏≤‡∏Å OM SAB White House Add-Ons Hide Product slug) ---

/**
 * ‡∏õ‡∏£‡∏±‡∏ö query ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
 */
add_action('woocommerce_product_query', 'evy_filter_product_visibility_frontend');
function evy_filter_product_visibility_frontend($q) {
    if (is_admin()) return;

    // ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏á‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢
    if (evy_user_has_full_access()) return;

    $tax_query = $q->get('tax_query') ?: [];
    $restricted_categories = evy_get_restricted_categories_slugs(); // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô

    if (evy_user_has_restricted_category_access()) {
        // ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏à‡∏≥‡∏Å‡∏±‡∏î: ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏±‡πâ‡∏ô
        $tax_query[] = [
            'taxonomy' => 'product_cat',
            'field'    => 'slug',
            'terms'    => $restricted_categories,
            'operator' => 'IN',
        ];
    } else {
        // ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ: ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏à‡∏≥‡∏Å‡∏±‡∏î
        $tax_query[] = [
            'taxonomy' => 'product_cat',
            'field'    => 'slug',
            'terms'    => $restricted_categories,
            'operator' => 'NOT IN',
        ];
    }

    $q->set('tax_query', $tax_query);
}

/**
 * ‡∏õ‡∏£‡∏±‡∏ö query ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö REST API (‡πÄ‡∏ä‡πà‡∏ô WooCommerce Mobile App) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
 */
add_filter('woocommerce_rest_product_query', 'evy_filter_product_visibility_rest', 10, 2);
add_filter('woocommerce_rest_product_object_query', 'evy_filter_product_visibility_rest', 10, 2);
function evy_filter_product_visibility_rest($args, $request) {
    // ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏á‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢
    if (evy_user_has_full_access()) return $args;

    $restricted_categories = evy_get_restricted_categories_slugs(); // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô

    if (evy_user_has_restricted_category_access()) {
        // ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏à‡∏≥‡∏Å‡∏±‡∏î: ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏±‡πâ‡∏ô
        $args['tax_query'][] = [
            'taxonomy' => 'product_cat',
            'field'    => 'slug',
            'terms'    => $restricted_categories,
            'operator' => 'IN',
        ];
    } else {
        // ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ: ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏à‡∏≥‡∏Å‡∏±‡∏î
        $args['tax_query'][] = [
            'taxonomy' => 'product_cat',
            'field'    => 'slug',
            'terms'    => $restricted_categories,
            'operator' => 'NOT IN',
        ];
    }

    return $args;
}

// --- End: Product Visibility Functions ---


// --- Start: Related Products Functions (‡∏à‡∏≤‡∏Å OM SAB Add-Ons Related Products on Theme storefront) ---

/**
 * ‡∏õ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
 */
add_filter('woocommerce_related_products', 'evy_filter_related_products_by_same_category', 10, 3);

function evy_filter_related_products_by_same_category($related_posts, $product_id, $args) {
    $terms = get_the_terms($product_id, 'product_cat');
    
    if ($terms && !is_wp_error($terms)) {
        $term_ids = wp_list_pluck($terms, 'term_id');
        
        if (empty($term_ids)) {
            return $related_posts;
        }

        $args = [
            'post_type'      => 'product',
            'posts_per_page' => 4,
            'post__not_in'   => [$product_id],
            'tax_query'      => [
                [
                    'taxonomy' => 'product_cat',
                    'field'    => 'term_id',
                    'terms'    => $term_ids,
                    'operator' => 'IN',
                ]
            ]
        ];

        $related_query = new WP_Query($args);
        
        if ($related_query->have_posts()) {
            $related_posts = wp_list_pluck($related_query->posts, 'ID');
        } else {
            $related_posts = [];
        }
    }
    return $related_posts;
}

// --- End: Related Products Functions ---
